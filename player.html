<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>YouDai Player</title>
  
  <script src="dev.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="/youdai/icons/icon-192.png">
  
  <script type="text/javascript"
  src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework">
</script>


  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      color: #ffffff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Top navigation bar */
    .top-nav {
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 15px;
    }

    .back-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .back-btn:hover {
      background: #4ecdc4;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:hover {
      background: #4ecdc4;
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
    }

    .nav-btn.cast-btn:hover {
      background: #ff6b6b;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }

    .nav-btn.share-btn:hover {
      background: #45b7d1;
      box-shadow: 0 4px 15px rgba(69, 183, 209, 0.3);
    }

    /* Player section */
    .player-section {
      background: #000;
      position: relative;
    }

    .player-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      aspect-ratio: 16 / 9;
      background: #000;
    }

    .player-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .player-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4ecdc4;
    }

    .loading {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(78, 205, 196, 0.3);
      border-radius: 50%;
      border-top-color: #4ecdc4;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .player-error {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      text-align: center;
      padding: 20px;
      display: none;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 20px;
      color: #ff6b6b;
    }

    .error-title {
      font-size: 20px;
      margin: 0 0 10px 0;
      font-weight: 600;
    }

    .error-message {
      margin: 0 0 20px 0;
      max-width: 400px;
      line-height: 1.5;
      opacity: 0.8;
    }

    .error-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .error-btn {
      background: #4ecdc4;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .error-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
    }

    .error-btn.external {
      background: #ff6b6b;
    }

    .error-btn.external:hover {
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }

    /* Video info section */
    .video-info {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 15px;
    }

    .video-title {
      font-size: clamp(18px, 4vw, 28px);
      font-weight: 700;
      line-height: 1.3;
      margin: 0 0 15px 0;
      color: #fff;
    }

    .video-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .meta-left {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .channel-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .channel-badge {
      background: linear-gradient(135deg, #4ecdc4, #45b7d1);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .video-date {
      color: rgba(255,255,255,0.7);
      font-size: 14px;
    }

    .video-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .action-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }

    .action-btn.cast:hover {
      background: #ff6b6b;
      color: white;
    }

    .action-btn.share:hover {
      background: #45b7d1;
      color: white;
    }

    /* Related videos section */
    .related-section {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 15px;
    }

    .section-title {
      font-size: clamp(20px, 3vw, 24px);
      font-weight: 700;
      margin: 0 0 25px 0;
      color: #fff;
    }

    .related-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    @media (min-width: 768px) {
      .related-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }
    }

    @media (min-width: 1024px) {
      .related-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 25px;
      }
    }

    .related-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .related-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
      border-color: rgba(78, 205, 196, 0.5);
    }

    .related-thumbnail {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      overflow: hidden;
    }

    .related-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .related-card:hover .related-thumbnail img {
      transform: scale(1.05);
    }

    .play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4ecdc4;
      font-size: 16px;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .related-card:hover .play-icon {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1);
    }

    .related-content {
      padding: 12px;
    }

    .related-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.3;
      margin: 0 0 8px 0;
      color: #fff;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .related-date {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      margin: 0;
    }

    /* Fullscreen styles - MINIMAL CHANGES ONLY */
    .fullscreen-player {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 10000;
      max-width: none;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .nav-container {
        padding: 0 10px;
      }

      .video-info {
        padding: 15px 10px;
      }

      .video-meta {
        flex-direction: column;
        align-items: flex-start;
      }

      .meta-left {
        width: 100%;
      }

      .video-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .related-section {
        padding: 30px 10px;
      }
    }

    /* Share modal */
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      z-index: 10001;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .share-content {
      background: rgba(30, 30, 30, 0.95);
      border-radius: 16px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .share-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 20px 0;
      color: #fff;
    }

    .share-url {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 12px;
      width: 100%;
      color: #fff;
      font-size: 14px;
      margin-bottom: 20px;
      outline: none;
    }

    .share-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .copy-btn, .open-btn, .close-btn {
      background: #4ecdc4;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .copy-btn:hover, .open-btn:hover {
      background: #45b7d1;
      transform: translateY(-2px);
    }

    .close-btn {
      background: rgba(255,255,255,0.2);
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Cast detection */
    .cast-available {
      color: #4ecdc4 !important;
    }

    /* Responsive design */
    @media (max-width: 480px) {
      .nav-container {
        padding: 0 10px;
      }

      .nav-actions {
        gap: 8px;
      }

      .nav-btn {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }

      .share-content {
        padding: 20px;
        margin: 10px;
      }
    }

    /* Hide elements when needed */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-container">
      <button class="back-btn" id="backBtn">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
      </button>
      
      <div class="nav-actions">
		<button class="nav-btn reload-btn" id="reloadBtn" title="Reload Page" onclick="location.reload()">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button class="nav-btn cast-btn" id="castBtn" title="Open Link">
          <i class="fa-solid fa-globe"></i>
        </button>
        <button class="nav-btn mxplayer-btn" id="mxPlayerBtn" title="Open in MX Player">
		  <i class="fas fa-play-circle"></i>
		</button>
      </div>
    </div>
  </nav>

  <!-- Player Section -->
  <section class="player-section">
    <div class="player-container" id="playerContainer">
      <div class="player-loading" id="playerLoading">
        <div class="loading"></div>
      </div>
      
      <iframe id="playerIframe" class="player-iframe" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
      
      <div class="player-error" id="playerError">
        <i class="fas fa-exclamation-triangle error-icon"></i>
        <h3 class="error-title">Unable to Load Video</h3>
        <p class="error-message">This video cannot be embedded. You can watch it on the original platform.</p>
        <div class="error-actions">
          <button class="error-btn" onclick="retryLoad()">Try Again</button>
          <a href="#" class="error-btn external" id="externalLink" target="_blank">Watch on Platform</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Video Info -->
  <section class="video-info">
    <h1 class="video-title" id="videoTitle">Loading...</h1>
    
    <div class="video-meta">
      <div class="meta-left">
        <div class="channel-info">
          <div class="channel-badge" id="channelName">Loading...</div>
        </div>
        <div class="video-date" id="videoDate">Loading...</div>
      </div>
    </div>
  </section>

  <!-- Related Videos -->
  <section class="related-section">
    <h2 class="section-title" id="relatedTitle">More from Channel</h2>
    <div class="related-grid" id="relatedGrid">
      <!-- Related videos will be populated here -->
    </div>
  </section>

  <!-- Share Modal -->
  <div class="share-modal" id="shareModal">
    <div class="share-content">
      <h3 class="share-title">Share Video</h3>
      <input type="text" class="share-url" id="shareUrl" readonly>
      <div class="share-actions">
        <button class="copy-btn" id="copyBtn">Copy Link</button>
        <button class="close-btn" id="closeShareBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    class VideoPlayer {
      constructor() {
        this.currentVideo = null;
        this.allVideos = [];
        this.relatedVideos = [];
        this.retryCount = 0;
        this.maxRetries = 3;
        
        this.elements = {
          playerIframe: document.getElementById('playerIframe'),
          playerLoading: document.getElementById('playerLoading'),
          playerError: document.getElementById('playerError'),
          playerContainer: document.getElementById('playerContainer'),
          videoTitle: document.getElementById('videoTitle'),
          channelName: document.getElementById('channelName'),
          videoDate: document.getElementById('videoDate'),
          relatedTitle: document.getElementById('relatedTitle'),
          relatedGrid: document.getElementById('relatedGrid'),
          shareModal: document.getElementById('shareModal'),
          shareUrl: document.getElementById('shareUrl'),
          copyBtn: document.getElementById('copyBtn'),
          closeShareBtn: document.getElementById('closeShareBtn'),
          castBtn: document.getElementById('castBtn'),
          shareBtn: document.getElementById('shareBtn'),
          externalLink: document.getElementById('externalLink')
        };

        this.init();
      }

      async init() {
        this.loadVideoData();
        this.setupEventListeners();
        this.setupMobileOrientationHandler(); // Only add this for mobile orientation
        this.detectCastDevices();
		this.initCast();
        this.loadVideo();
      }
	  
initCast() {
  if (!window.chrome || !window.chrome.cast) {
    console.log('Cast API not available');
    return;
  }

  window['__onGCastApiAvailable'] = (isAvailable) => {
    if (isAvailable) {
      try {
        const context = cast.framework.CastContext.getInstance();
        context.setOptions({
          receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED
        });
        
        // Listen for session state changes
        context.addEventListener(
          cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
          (event) => this.handleCastSessionChange(event)
        );
        
        console.log("Cast initialized successfully");
        this.updateCastButton();
      } catch (error) {
        console.error('Cast initialization failed:', error);
      }
    } else {
      console.log('Cast API not available');
    }
  };
}


      // MINIMAL ADDITION - Only handle mobile orientation in fullscreen
      setupMobileOrientationHandler() {
        // Handle fullscreen changes to manage orientation on mobile
        const handleFullscreenChange = async () => {
          const isFullscreen = !!(document.fullscreenElement || 
                                 document.webkitFullscreenElement || 
                                 document.mozFullScreenElement);

          // Only attempt orientation lock on mobile devices
          const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                          window.innerWidth <= 768;

          if (isFullscreen && isMobile) {
            // Try to lock to landscape when entering fullscreen on mobile
            if (screen.orientation && screen.orientation.lock) {
              try {
                await screen.orientation.lock('landscape-primary');
              } catch (error) {
                // Fallback: try alternative landscape orientation
                try {
                  await screen.orientation.lock('landscape');
                } catch (altError) {
                  console.log('Orientation lock not supported:', altError);
                }
              }
            }
          } else if (!isFullscreen && isMobile) {
            // Unlock orientation when exiting fullscreen
            if (screen.orientation && screen.orientation.unlock) {
              screen.orientation.unlock();
            }
          }
        };

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
      }

      loadVideoData() {
        // Get video data from sessionStorage
        const videoData = sessionStorage.getItem('currentVideo');
        const allVideosData = sessionStorage.getItem('allVideos');

        if (!videoData) {
          // Redirect back if no video data
          window.location.href = 'index.html';
          return;
        }

        this.currentVideo = JSON.parse(videoData);
        this.allVideos = allVideosData ? JSON.parse(allVideosData) : [];
        
        // Get related videos from same channel
        this.relatedVideos = this.allVideos
          .filter(v => v.channel === this.currentVideo.channel && v.id !== this.currentVideo.id)
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 8); // Show max 8 related videos

        this.updateUI();
      }

      updateUI() {
        const { title, channel, date } = this.currentVideo;
        
        this.elements.videoTitle.textContent = title;
        this.elements.channelName.textContent = channel;
        this.elements.videoDate.textContent = this.formatDate(date);
        this.elements.relatedTitle.textContent = `More from ${channel}`;

        document.title = `${title} - YouDai Player`;

        // Use direct video link instead of page URL
        this.elements.shareUrl.value = this.getDirectVideoLink();

        // External platform link
        this.updateExternalLink();

        this.renderRelatedVideos();
      }

      getDirectVideoLink() {
        const { platform, id } = this.currentVideo;
        switch(platform) {
          case 'youtube': return `https://www.youtube.com/watch?v=${id}`;
          case 'dailymotion': return `https://www.dailymotion.com/video/${id}`;
          case 'ok': return `https://ok.ru/video/${id}`;
          case 'yupptv': return `https://www.yupptv.com/yupptvnew/channels/${id}/live`;
          default: return window.location.href;
        }
      }

      updateExternalLink() {
        const { platform, id } = this.currentVideo;
        let url = '#';
        
        switch(platform) {
          case 'youtube':
            url = `https://www.youtube.com/watch?v=${id}`;
            break;
          case 'dailymotion':
            url = `https://www.dailymotion.com/video/${id}`;
            break;
          case 'ok':
            url = `https://ok.ru/video/${id}`;
            break;
          case 'yupptv':
            url = `https://www.yupptv.com/yupptvnew/channels/${id}/live`;
            break;
        }
        
        this.elements.externalLink.href = url;
        this.elements.externalLink.textContent = `Watch on ${platform.charAt(0).toUpperCase() + platform.slice(1)}`;
      }

      formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', { 
          day: 'numeric', 
          month: 'short',
          year: 'numeric'
        });
      }

      getOptimalThumbnail(video) {
        return window.innerWidth < 768 ? video.mthumb : video.dthumb;
      }

      renderRelatedVideos() {
        if (this.relatedVideos.length === 0) {
          this.elements.relatedGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
              <i class="fas fa-video" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
              <p>No related videos found</p>
            </div>
          `;
          return;
        }

        this.elements.relatedGrid.innerHTML = this.relatedVideos.map(video => `
          <div class="related-card" data-platform="${video.platform}" data-id="${video.id}">
            <div class="related-thumbnail">
              <img src="${this.getOptimalThumbnail(video)}" alt="${video.title}" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
              <div class="play-icon">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="related-content">
              <h3 class="related-title">${video.title}</h3>
              <p class="related-date">${this.formatDate(video.date)}</p>
            </div>
          </div>
        `).join('');

        // Add click listeners to related videos
        setTimeout(() => {
          const relatedCards = this.elements.relatedGrid.querySelectorAll('.related-card');
          relatedCards.forEach(card => {
            card.addEventListener('click', () => {
              const platform = card.dataset.platform;
              const id = card.dataset.id;
              const video = this.allVideos.find(v => v.platform === platform && v.id === id);
              
              if (video) {
                this.playRelatedVideo(video);
              }
            });
          });
        }, 100);
      }

      playRelatedVideo(video) {
        // Update current video data
        this.currentVideo = video;
        sessionStorage.setItem('currentVideo', JSON.stringify(video));
        
        // Update related videos
        this.relatedVideos = this.allVideos
          .filter(v => v.channel === video.channel && v.id !== video.id)
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 8);

        // Reset retry count
        this.retryCount = 0;
        
        // Update UI and load new video
        this.updateUI();
        this.loadVideo();
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      loadVideo() {
        this.showLoading();
        this.hideError();
        
        const { platform, id } = this.currentVideo;
        let embedUrl = this.getEmbedUrl(platform, id);
        
        this.elements.playerIframe.src = embedUrl;
        
        // Set loading timeout
        const loadTimeout = setTimeout(() => {
          this.handleLoadError();
        }, 8000);

        // Handle successful load
        this.elements.playerIframe.onload = () => {
          clearTimeout(loadTimeout);
          this.hideLoading();
          console.log('Video loaded successfully');
        };

        // Handle load errors
        this.elements.playerIframe.onerror = () => {
          clearTimeout(loadTimeout);
          this.handleLoadError();
        };
      }

      getEmbedUrl(platform, id, retryAttempt = 0) {
        switch(platform) {
          case 'youtube':
            const ytUrls = [
              `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0&modestbranding=1&controls=1`,
              `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1&controls=1`,
              `https://www.youtube-nocookie.com/embed/${id}?rel=0&controls=1`
            ];
            return ytUrls[retryAttempt] || ytUrls[0];
            
          case 'dailymotion':
            return `https://www.dailymotion.com/embed/video/${id}?autoplay=1&ui-logo=0&controls=1`;
            
          case 'ok':
            return `https://ok.ru/videoembed/${id}?autoplay=1`;
			
          case 'yupptv':
            return `https://www.yupptv.com/yupptvnew/channels/${id}/live/embed`;
            
          default:
            return '';
        }
      }

      showLoading() {
        this.elements.playerLoading.style.display = 'flex';
        this.elements.playerError.style.display = 'none';
      }

      hideLoading() {
        this.elements.playerLoading.style.display = 'none';
      }

      showError() {
        this.elements.playerError.style.display = 'flex';
        this.elements.playerLoading.style.display = 'none';
      }

      hideError() {
        this.elements.playerError.style.display = 'none';
      }

      handleLoadError() {
        if (this.retryCount < this.maxRetries) {
          this.retryCount++;
          console.log(`Retry attempt ${this.retryCount} of ${this.maxRetries}`);
          
          setTimeout(() => {
            const { platform, id } = this.currentVideo;
            const embedUrl = this.getEmbedUrl(platform, id, this.retryCount - 1);
            this.elements.playerIframe.src = embedUrl;
            
            const retryTimeout = setTimeout(() => {
              this.handleLoadError();
            }, 5000 * this.retryCount); // Increasing timeout
            
            this.elements.playerIframe.onload = () => {
              clearTimeout(retryTimeout);
              this.hideLoading();
              console.log(`Successfully loaded on retry ${this.retryCount}`);
            };
          }, 1000 * this.retryCount);
        } else {
          this.showError();
        }
      }

      setupEventListeners() {
        // MX Player button
		this.elements.mxPlayerBtn = document.getElementById('mxPlayerBtn');
		this.elements.mxPlayerBtn.addEventListener('click', () => this.openInMxPlayer());


        // Share modal
        this.elements.copyBtn.addEventListener('click', () => this.copyShareUrl());
        this.elements.closeShareBtn.addEventListener('click', () => this.closeShareModal());
        this.elements.shareModal.addEventListener('click', (e) => {
          if (e.target === this.elements.shareModal) this.closeShareModal();
        });

        // Cast button
        this.elements.castBtn.addEventListener('click', () => this.handleCast());
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          switch(e.key) {
            case 'Escape':
              if (this.elements.shareModal.style.display === 'flex') {
                this.closeShareModal();
              }
              break;
            case 'f':
            case 'F':
              if (document.activeElement !== document.querySelector('input')) {
                e.preventDefault();
                this.toggleFullscreen();
              }
              break;
          }
        });

		// Back button
		this.elements.backBtn = document.getElementById('backBtn');
		this.elements.backBtn.addEventListener("click", () => {
			window.location.href = "index.html";
		});
      }

      openShareModal() {
        this.elements.shareModal.style.display = 'flex';
        this.elements.shareUrl.select();
      }

      closeShareModal() {
        this.elements.shareModal.style.display = 'none';
      }

      async copyShareUrl() {
        try {
          await navigator.clipboard.writeText(this.elements.shareUrl.value);
          this.elements.copyBtn.textContent = 'Copied!';
          this.elements.copyBtn.style.background = '#4ecdc4';
          
          setTimeout(() => {
            this.elements.copyBtn.textContent = 'Copy Link';
            this.elements.copyBtn.style.background = '#4ecdc4';
          }, 2000);
        } catch (err) {
          // Fallback for older browsers
          this.elements.shareUrl.select();
          document.execCommand('copy');
          this.elements.copyBtn.textContent = 'Copied!';
          
          setTimeout(() => {
            this.elements.copyBtn.textContent = 'Copy Link';
          }, 2000);
        }
      }

      detectCastDevices() {
        if (window.chrome && window.chrome.cast) {
          this.elements.castBtn.classList.add('cast-available');
        }

        if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
          this.elements.castBtn.style.opacity = '1';
        }
      }

handleCast() {
  const { platform, id } = this.currentVideo;

  if (platform === "dailymotion") {
    fetch(`https://www.dailymotion.com/player/metadata/video/${id}`)
      .then(res => res.json())
      .then(data => {
        const hls = data.qualities.auto?.[0]?.url;
        if (hls) {
          const mediaInfo = new chrome.cast.media.MediaInfo(hls, 'application/x-mpegURL');
          const request = new chrome.cast.media.LoadRequest(mediaInfo);

          cast.framework.CastContext.getInstance().requestSession()
            .then(session => {
              session.loadMedia(request).then(
                () => console.log("Casting started"),
                (err) => console.error("Load error", err)
              );
            })
            .catch(err => console.error("Cast session error", err));
        } else {
          window.open(`https://www.dailymotion.com/video/${id}`, "_blank");
        }
      })
      .catch(err => {
        console.error("Metadata fetch error", err);
        window.open(`https://www.dailymotion.com/video/${id}`, "_blank");
      });
  } else {
    // fallback for other platforms
    window.open(this.getDirectVideoLink(), "_blank");
  }
}

      toggleFullscreen() {
        if (!document.fullscreenElement) {
          this.elements.playerContainer.requestFullscreen().catch(err => {
            console.log('Fullscreen error:', err);
          });
        } else {
          document.exitFullscreen();
        }
      }

      // Global retry function
      retryLoad() {
        this.retryCount = 0;
        this.loadVideo();
      }

// SOLUTION 1: Server-Side Proxy (Recommended)
// Create a simple server endpoint that fetches the stream URL

// Backend (Node.js/Express example):
/*
app.get('/api/dailymotion-stream/:videoId', async (req, res) => {
  try {
    const { videoId } = req.params;
    const response = await fetch(`https://www.dailymotion.com/player/metadata/video/${videoId}`, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36',
        'Referer': `https://www.dailymotion.com/video/${videoId}`
      }
    });
    
    const data = await response.json();
    const streamUrl = data.qualities?.auto?.[0]?.url || 
                     data.stream_h264_url || 
                     data.stream_hls_url;
    
    res.json({ streamUrl, success: !!streamUrl });
  } catch (error) {
    res.status(500).json({ error: error.message, success: false });
  }
});
*/

// Frontend implementation:
async getDailymotionStreamViaProxy(videoId) {
  try {
    const response = await fetch(`/api/dailymotion-stream/${videoId}`);
    const data = await response.json();
    
    if (data.success && data.streamUrl) {
      console.log('Stream URL from proxy:', data.streamUrl);
      return data.streamUrl;
    }
    
    throw new Error('No stream URL from proxy');
  } catch (error) {
    console.error('Proxy method failed:', error);
    return null;
  }
}

// SOLUTION 2: Working CORS Proxies (Multiple fallbacks)
async getDailymotionStreamViaCORS(videoId) {
  const workingProxies = [
    // Public CORS proxies that currently work
    {
      name: 'AllOrigins',
      url: (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
      parser: (response) => JSON.parse(response.contents)
    },
    {
      name: 'CorsProxy',
      url: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
      parser: (response) => response
    },
    {
      name: 'ThingProxy',
      url: (url) => `https://thingproxy.freeboard.io/fetch/${url}`,
      parser: (response) => response
    },
    {
      name: 'Proxy6',
      url: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
      parser: (response) => response
    }
  ];

  const metadataUrl = `https://www.dailymotion.com/player/metadata/video/${videoId}`;

  for (const proxy of workingProxies) {
    try {
      console.log(`Trying ${proxy.name}...`);
      
      const response = await fetch(proxy.url(metadataUrl), {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36'
        }
      });

      if (!response.ok) {
        console.log(`${proxy.name} failed: ${response.status}`);
        continue;
      }

      const rawData = await response.json();
      const data = proxy.parser(rawData);
      
      // Extract stream URL
      const streamUrl = data.qualities?.auto?.[0]?.url || 
                       data.stream_h264_url || 
                       data.stream_hls_url ||
                       data.manifest_urls?.hls;

      if (streamUrl && streamUrl.startsWith('http')) {
        console.log(`Success with ${proxy.name}:`, streamUrl);
        return streamUrl;
      }

    } catch (error) {
      console.error(`${proxy.name} error:`, error);
      continue;
    }
  }

  throw new Error('All CORS proxies failed');
}

// SOLUTION 3: Chrome Extension Method (Advanced)
// Create a Chrome extension with host permissions

// manifest.json:
/*
{
  "manifest_version": 3,
  "name": "Video Stream Extractor",
  "version": "1.0",
  "permissions": ["activeTab"],
  "host_permissions": ["https://www.dailymotion.com/*"],
  "content_scripts": [{
    "matches": ["https://yourdomain.com/*"],
    "js": ["content.js"]
  }]
}
*/

// Extension method (if extension available):
async getDailymotionStreamViaExtension(videoId) {
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    try {
      const response = await chrome.runtime.sendMessage({
        action: 'fetchDailymotionStream',
        videoId: videoId
      });
      
      if (response && response.streamUrl) {
        return response.streamUrl;
      }
    } catch (error) {
      console.log('Extension method failed:', error);
    }
  }
  
  return null;
}

// SOLUTION 4: Web Scraping via Puppeteer (Server-side)
// Backend implementation:
/*
const puppeteer = require('puppeteer');

app.get('/api/dailymotion-puppeteer/:videoId', async (req, res) => {
  let browser;
  try {
    browser = await puppeteer.launch({ headless: true });
    const page = await browser.newPage();
    
    await page.setUserAgent('Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36');
    
    // Intercept network requests
    await page.setRequestInterception(true);
    let streamUrl = null;
    
    page.on('request', request => {
      request.continue();
    });
    
    page.on('response', async response => {
      const url = response.url();
      if (url.includes('player/metadata/video') || url.includes('.m3u8') || url.includes('.mp4')) {
        try {
          const data = await response.json();
          streamUrl = data.qualities?.auto?.[0]?.url || data.stream_h264_url;
        } catch (e) {
          // Not JSON response
        }
      }
    });
    
    await page.goto(`https://www.dailymotion.com/video/${req.params.videoId}`);
    await page.waitForTimeout(3000);
    
    res.json({ streamUrl, success: !!streamUrl });
  } catch (error) {
    res.status(500).json({ error: error.message, success: false });
  } finally {
    if (browser) await browser.close();
  }
});
*/

// SOLUTION 5: Alternative API Endpoints
async getDailymotionStreamAlternative(videoId) {
  const alternativeEndpoints = [
    `https://www.dailymotion.com/services/oembed?url=https://www.dailymotion.com/video/${videoId}&format=json`,
    `https://www.dailymotion.com/json/video/${videoId}`,
    `https://api.dailymotion.com/video/${videoId}?fields=stream_h264_url,stream_hls_url`
  ];

  for (const endpoint of alternativeEndpoints) {
    try {
      const response = await fetch(endpoint);
      if (response.ok) {
        const data = await response.json();
        const streamUrl = data.stream_h264_url || data.stream_hls_url || data.url;
        
        if (streamUrl) {
          return streamUrl;
        }
      }
    } catch (error) {
      console.log('Alternative endpoint failed:', endpoint);
    }
  }
  
  return null;
}

// MAIN IMPLEMENTATION: Try all methods in sequence
async getDailymotionStream(videoId) {
  console.log('Starting comprehensive stream extraction for:', videoId);

  // Method 1: Server proxy (most reliable)
  try {
    const streamUrl = await this.getDailymotionStreamViaProxy(videoId);
    if (streamUrl) return streamUrl;
  } catch (error) {
    console.log('Proxy method not available');
  }

  // Method 2: CORS proxies
  try {
    const streamUrl = await this.getDailymotionStreamViaCORS(videoId);
    if (streamUrl) return streamUrl;
  } catch (error) {
    console.log('CORS proxy methods failed');
  }

  // Method 3: Extension (if available)
  try {
    const streamUrl = await this.getDailymotionStreamViaExtension(videoId);
    if (streamUrl) return streamUrl;
  } catch (error) {
    console.log('Extension method not available');
  }

  // Method 4: Alternative endpoints
  try {
    const streamUrl = await this.getDailymotionStreamAlternative(videoId);
    if (streamUrl) return streamUrl;
  } catch (error) {
    console.log('Alternative endpoints failed');
  }

  // All methods failed
  throw new Error('Unable to extract stream URL - all methods exhausted');
}

// UPDATED openInMxPlayer - ONLY MX Player, no fallbacks
openInMxPlayer() {
  const { platform, id } = this.currentVideo;

  // Show loading
  this.elements.mxPlayerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  this.elements.mxPlayerBtn.disabled = true;

  if (platform === "dailymotion") {
    console.log('Extracting Dailymotion stream for MX Player:', id);

    this.getDailymotionStream(id)
      .then(streamUrl => {
        if (streamUrl && streamUrl.startsWith('http')) {
          console.log('SUCCESS! Stream URL extracted:', streamUrl);
          this.launchMxPlayerOnly(streamUrl, this.currentVideo.title);
        } else {
          throw new Error('No valid stream URL extracted');
        }
      })
      .catch(error => {
        console.error('Stream extraction failed:', error);
        this.showStreamExtractionFailed(id, error.message);
      })
      .finally(() => {
        // Reset button
        setTimeout(() => {
          this.elements.mxPlayerBtn.innerHTML = '<i class="fas fa-play-circle"></i>';
          this.elements.mxPlayerBtn.disabled = false;
        }, 2000);
      });

  } else {
    // For other platforms, try direct URL in MX Player
    const directUrl = this.getDirectVideoLink();
    this.launchMxPlayerOnly(directUrl, this.currentVideo.title);
    
    // Reset button
    setTimeout(() => {
      this.elements.mxPlayerBtn.innerHTML = '<i class="fas fa-play-circle"></i>';
      this.elements.mxPlayerBtn.disabled = false;
    }, 2000);
  }
}

// Launch ONLY MX Player - no fallbacks
launchMxPlayerOnly(streamUrl, title) {
  const isAndroid = /Android/i.test(navigator.userAgent);
  
  if (!isAndroid) {
    alert('MX Player is only available on Android devices.');
    return;
  }

  console.log('Launching MX Player with URL:', streamUrl);
  
  // Use your working format
  const cleanUrl = streamUrl.replace(/^https?:\/\//, '');
  const scheme = streamUrl.startsWith('https') ? 'https' : 'http';
  const mxIntent = `intent://${cleanUrl}#Intent;package=com.mxtech.videoplayer.ad;scheme=${scheme};end;`;
  
  try {
    window.location.href = mxIntent;
    
    // Only show install option if MX Player not found
    setTimeout(() => {
      if (!document.hidden) {
        this.showMxPlayerInstallOnly();
      }
    }, 3000);
    
  } catch (error) {
    console.error('MX Player launch failed:', error);
    this.showMxPlayerInstallOnly();
  }
}

// Show ONLY MX Player install option
showMxPlayerInstallOnly() {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(10px);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;

  modal.innerHTML = `
    <div style="
      background: rgba(30, 30, 30, 0.95);
      border-radius: 16px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    ">
      <i class="fas fa-mobile-alt" style="color: #ff6b6b; font-size: 48px; margin-bottom: 20px;"></i>
      <h3 style="color: white; margin: 0 0 15px 0;">MX Player Required</h3>
      <p style="color: rgba(255,255,255,0.7); margin: 0 0 25px 0; line-height: 1.5;">
        MX Player is not installed or couldn't be launched. Please install MX Player to continue.
      </p>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button id="installMxBtn" style="
          background: #ff6b6b;
          border: none;
          border-radius: 8px;
          padding: 12px 20px;
          color: white;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
        ">Install MX Player</button>
        <button id="closeModalBtn" style="
          background: rgba(255,255,255,0.2);
          border: none;
          border-radius: 8px;
          padding: 10px 20px;
          color: white;
          cursor: pointer;
          font-size: 14px;
        ">Close</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector('#installMxBtn').onclick = () => {
    const playStoreUrl = 'https://play.google.com/store/apps/details?id=com.mxtech.videoplayer.ad';
    const playStoreIntent = 'intent://details?id=com.mxtech.videoplayer.ad#Intent;scheme=market;package=com.android.vending;end;';
    
    try {
      window.location.href = playStoreIntent;
      setTimeout(() => window.open(playStoreUrl, '_blank'), 2000);
    } catch (error) {
      window.open(playStoreUrl, '_blank');
    }
    document.body.removeChild(modal);
  };

  modal.querySelector('#closeModalBtn').onclick = () => {
    document.body.removeChild(modal);
  };

  modal.onclick = (e) => {
    if (e.target === modal) document.body.removeChild(modal);
  };
}

// Show detailed error when stream extraction fails
showStreamExtractionFailed(videoId, errorMessage) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10001;
    display: flex; align-items: center; justify-content: center; padding: 20px;
  `;

  modal.innerHTML = `
    <div style="background: rgba(30, 30, 30, 0.95); border-radius: 16px; padding: 30px; max-width: 500px; width: 100%; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
      <i class="fas fa-exclamation-triangle" style="color: #ff6b6b; font-size: 48px; margin-bottom: 20px;"></i>
      <h3 style="color: white; margin: 0 0 15px 0;">Stream Extraction Failed</h3>
      <p style="color: rgba(255,255,255,0.7); margin: 0 0 15px 0; line-height: 1.5;">
        Unable to extract direct stream URL for MX Player.<br>
        <small>Error: ${errorMessage}</small>
      </p>
      <p style="color: rgba(255,255,255,0.6); margin: 0 0 25px 0; font-size: 14px;">
        This usually happens due to CORS restrictions. Consider setting up a server proxy.
      </p>
      <button id="closeBtn" style="background: #4ecdc4; border: none; border-radius: 8px; padding: 10px 20px; color: white; cursor: pointer;">Close</button>
    </div>
  `;

  document.body.appendChild(modal);
  modal.querySelector('#closeBtn').onclick = () => document.body.removeChild(modal);
  modal.onclick = (e) => { if (e.target === modal) document.body.removeChild(modal); };
}
    }

    // Initialize player when DOM is ready
    let player;
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        player = new VideoPlayer();
      });
    } else {
      player = new VideoPlayer();
    }

    // Make retry function globally accessible
    window.retryLoad = () => {
      if (player) {
        player.retryLoad();
      }
    };

    // Handle offline/online status
    window.addEventListener('online', () => {
      console.log('Connection restored');
      if (player && document.getElementById('playerError').style.display === 'flex') {
        player.retryLoad();
      }
    });

    window.addEventListener('offline', () => {
      console.log('Connection lost');
    });

    // Service Worker registration (optional for PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // navigator.serviceWorker.register('/sw.js')
        //   .then(registration => console.log('SW registered'))
        //   .catch(error => console.log('SW registration failed'));
      });
    }
  </script>
</body>
</html>